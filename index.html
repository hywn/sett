<link rel="stylesheet" href="sett.css" />

<div id="audios" class="box">
	<audio controls></audio>
	<audio controls></audio>
</div>
<div class="box">
	hi
</div>
<div class="box">
	hi
</div>
<div id="editor-wrapper" class="box">
	<pre id="editor" contenteditable="true"></pre>
</div>

<script>
const EDITOR = document.querySelector('#editor')
const TRACKS = [...document.querySelectorAll('#audios audio')]

function number_arg(arg)
{
	const num = Number(arg)

	if (isNaN(num)) {
		console.error(`argument "${arg}" is not a number!`)
		return 0
	}

	return num
}

function handle_command(string)
{
	const [, command, trackno_str, rest] = string.match(/^([a-z]+)\s+(\d+)(?:\s+)?(.*)/) || []
	const subcommands = Object.fromEntries([...(rest || '').matchAll(/([a-z]+)\s+([^\s]+)/g)].map(match => match.slice(1)))

	const track = TRACKS[Number(trackno_str) - 1]

	if (!command)
		return
	if (!track)
		return

	if(subcommands.with)
		track.src = subcommands.with;

	if(subcommands.from)
		track.currentTime = number_arg(subcommands.from)

	if(command == 'play')
		track.play()
}

/*****************************/
/** editor saving & running **/
/*****************************/

function handle_input(string)
{
	string
		.replace(/# .+/, '')
		.split('\n')
		.filter(line => line.trim() !== '')
		.forEach(line => handle_command(line))
}

EDITOR.addEventListener('keydown', e => {

	if (e.ctrlKey && e.key === 'd') {
		TRACKS.forEach(a => a.pause())

		e.preventDefault()
		return
	}

	if (!(e.ctrlKey && e.key === 's')) return

	window.localStorage.setItem(KEY, EDITOR.innerText)

	handle_input(EDITOR.innerText)

	e.preventDefault()

})

const KEY = 'sett_editor'
const TUTORIAL = 'hi'

// load from 1. src 2. browser 3. tutorial
const src_url = new URLSearchParams(window.location.search).get('src')
;(async function() {

	EDITOR.innerText =
		src_url ? await fetch(src_url).then(r => r.text())
		        : window.localStorage.getItem(KEY) || TUTORIAL

})();

</script>